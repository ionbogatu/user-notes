<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Single Note</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round|Open+Sans">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style type="text/css">
        body {
            color: #404E67;
            background: #F5F7FA;
            font-family: 'Open Sans', sans-serif;
        }

        .table-wrapper {
            width: 700px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
        }

        .table-title {
            padding-bottom: 10px;
            margin: 0 0 10px;
        }

        .table-title h2 {
            margin: 6px 0 0;
            font-size: 22px;
        }

        .table-title .add-new {
            float: right;
            height: 30px;
            font-weight: bold;
            font-size: 12px;
            text-shadow: none;
            min-width: 100px;
            border-radius: 50px;
            line-height: 13px;
        }

        .table-title .add-new i {
            margin-right: 4px;
        }

        table.table {
            table-layout: fixed;
        }

        table.table tr th, table.table tr td {
            border-color: #e9e9e9;
        }

        table.table th i {
            font-size: 13px;
            margin: 0 5px;
            cursor: pointer;
        }

        table.table th:last-child {
            width: 100px;
        }

        table.table td a {
            cursor: pointer;
            display: inline-block;
            margin: 0 5px;
            min-width: 24px;
        }

        table.table td a.add {
            color: #27C46B;
        }

        table.table td a.edit {
            color: #FFC107;
        }

        table.table td a.delete {
            color: #E34724;
        }

        table.table td i {
            font-size: 19px;
        }

        table.table td a.add i {
            font-size: 24px;
            margin-right: -1px;
            position: relative;
            top: 3px;
        }

        table.table .form-control {
            height: 32px;
            line-height: 32px;
            box-shadow: none;
            border-radius: 2px;
        }

        table.table .form-control.error {
            border-color: #f50000;
        }

        table.table td .add {
            display: none;
        }

        .d-none {
            display: none !important;
        }

        .d-flex {
            display: flex !important;
        }

        .ml-auto {
            margin-left: auto;
        }

        .mr-auto {
            margin-right: auto;
        }

        .mr-3 {
            margin-right: 1rem;
        }

        .p-3 {
            padding: 1rem !important;
        }

        .alert {
            position: relative;
            padding: .75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: .25rem;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .nav,
        .nav-login {
            display: none;
        }
    </style>
</head>
<body>
    <div class="nav p-3">
        <button type="button" class="btn btn-info login-google" onclick="googleLogin()">Login with google</button>
        <button type="button" class="btn btn-info login-facebook" onclick="facebookLogin()">Login with facebook</button>
    </div>
    <div class="nav-login p-3">
        <button type="button" class="btn btn-info login-google" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="message d-none"></div>
        <div class="table-wrapper">
            <div class="table-title">
                <div class="row">
                    <div class="col-sm-8"><h2 class="master-note-title"></h2></div>
                </div>
            </div>
            <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>Notes</th>
                    <th class="logged-in d-none">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div>
            <div class="d-flex">
                <div class="form-check ml-auto mr-3">
                    <input class="form-check-input" type="checkbox" id="option1" disabled>
                    <label class="form-check-label" for="option1">
                        Option 1
                    </label>
                </div>
                <div class="mr-auto">
                    <input class="form-check-input" type="checkbox" id="option2" disabled>
                    <label class="form-check-label" for="option2">
                        Option 2
                    </label>
                </div>
            </div>
            <div class="d-flex">
                <button type="button" class="btn btn-info ml-auto mr-auto d-none" id="update">Update</button>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/5.11.1/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/5.11.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.11.1/firebase-firestore.js"></script>
<script type="text/javascript">
    function hasEmptyRows(highlight = false) {
        var empty = false;

        $('.table-wrapper table tbody tr input[type="text"]').each(function() {
            if(!$(this).val()){
                if (highlight) {
                    $(this).addClass("error");
                }
                empty = true;
            } else{
                if (highlight) {
                    $(this).removeClass("error");
                }
            }
        });

        return empty;
    }

    function getShortId() {
        var hrefParts = window.location.href.split("/");

        return hrefParts[hrefParts.length - 1];
    }

    function reloadNotes() {
        var noteShortId = getShortId();

        var db = firebase.firestore();

        db.collection("MasterNotes").where("shortId", "==", parseInt(noteShortId)).get()
            .then(function (result) {
                if (result.docs[0].id) {
                    var data = result.docs[0].data();

                    if (data.status === "delete") {
                        $('.main').addClass('d-none');
                        $('.message').closest('.container').removeClass('d-none');
                        $('.message').html('<p class="alert alert-danger">The record was deleted</p>');
                    } else {
                        $('.master-note-title').text(data.name)

                        $notes = $('.table-bordered tbody');
                        $notes.html('');

                        var actions = '<a class="add" title="Add" data-toggle="tooltip"><i class="material-icons">&#xE03B;</i></a>' +
                            '<a class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons">&#xE254;</i></a>' +
                            '<a class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons">&#xE872;</i></a>';

                        for (var note of data.notes) {
                            $notes.append('<tr>' +
                                '<td data-name="note">' + note.note + '</td>' +
                                '<td data-name="label">' + note.label + '</td>' +
                                '<td class="logged-in d-none">' + actions + '</td>' +
                                '</tr>')
                        }

                        if (data.options.op1) {
                            $('#option1').attr('checked', 'checked');
                        }

                        if (data.options.op2) {
                            $('#option2').attr('checked', 'checked');
                        }

                        if (firebase.auth().currentUser) {
                            $('#update').removeClass('d-none');
                            $('#option1').removeAttr("disabled");
                            $('#option2').removeAttr("disabled");
                            $('.logged-in').each(function() {
                                $(this).removeClass('d-none');
                            });
                        } else {
                            $('#update').addClass('d-none');
                            $('#option1').attr("disabled", "disabled");
                            $('#option2').attr("disabled", "disabled");
                            $('.logged-in').each(function() {
                                $(this).addClass('d-none');
                            });
                        }
                    }
                }
            })
            .catch(function (error) {
                $('.main').addClass('d-none');
                $('.message').closest('.container').removeClass('d-none');
                $('.mesasge').html('<p class="alert alert-danger">Could not find the record</p>');
                console.error(error);
            });
    }

    function getLocationOrIP() {
        return new Promise(function (resolve) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    resolve({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    });
                }, function(error) {
                    $.getJSON("https://httpbin.org/ip", function(data){
                        if (data && data.origin) {
                            var ips = data.origin.split(', ');

                            if (ips && ips[0]) {
                                resolve(ips[0]);
                            } else {
                                resolve(null);
                            }
                        } else {
                            resolve(null);
                        }
                    });
                });
            } else {
                $.getJSON("https://httpbin.org/ip", function(data){
                    if (data && data.origin) {
                        var ips = data.origin.split(', ');

                        if (ips && ips[0]) {
                            resolve(ips[0]);
                        } else {
                            resolve(null);
                        }
                    } else {
                        resolve(null);
                    }
                });
            }
        });
    } 

    function updateStats() {
        var db = firebase.firestore();

        var masterNotesCollection = db.collection("MasterNotes");
        var masterStatsCollection = db.collection("MasterStats");

        var shortId = getShortId();

        masterNotesCollection.where("shortId", "==", parseInt(shortId)).get()
            .then(function (result) {
                if (result.docs[0].id) {
                    masterNotesCollection.doc(result.docs[0].id).update({
                        totalVisits: result.docs[0].data().totalVisits + 1
                    }).catch(function (error) {
                        $('.table-wrapper').addClass('d-none');
                        $('.message').removeClass('d-none');
                        $('.message').html('<p class="alert alert-danger">Could not update total visits</p>');
                        console.error(error);
                    });

                    const now = new Date();
                    var dateCreated = now.getUTCFullYear() + '-' + now.getUTCMonth() + '-' + now.getUTCDate() + ' ' + now.getUTCHours() + ':' + now.getUTCMinutes() + ':' + now.getUTCSeconds();

                    getLocationOrIP().then(function(result) {
                        if (typeof result === "string") { // ip
                            masterStatsCollection.add({
                                shortId: parseInt(shortId),
                                date: dateCreated,
                                ip: result,
                                geo: null
                            });
                        } else { // coords or null
                            masterStatsCollection.add({
                                shortId: parseInt(shortId),
                                date: dateCreated,
                                ip: null,
                                geo: result
                            });
                        }
                    });
                }
            })
            .catch(function (error) {
                $('.table-wrapper').addClass('d-none');
                $('.message').removeClass('d-none');
                $('.message').html('<p class="alert alert-danger">Could not get the notes</p>');
                console.error(error);
            });
    } 

    function updateNote() {
        var name = ($('.master-note-title-input').length === 1) ? $('.master-note-title-input').val() : $('.master-note-title').text();

        notes = [];

        $('.message').html('');

        if ($('.table-wrapper table tbody tr').length > 0) {
            $('.table-wrapper table tbody tr').each(function() {
                var label = ($(this).find('td input[name="label"]').length === 1) ? $(this).find('td input[name="label"]').val() : $(this).find('td[data-name="label"]').text();
                var note = ($(this).find('td input[name="note"]').length === 1) ? $(this).find('td input[name="note"]').val() : $(this).find('td[data-name="note"]').text();

                notes.push({
                    label: escapeHtml(label),
                    note: escapeHtml(note),
                });
            });

            var document = {
                name: escapeHtml(name),
                notes: notes,
                options: {
                    op1: $('#option1').is(':checked'),
                    op2: $('#option2').is(':checked')
                }
            };

            var db = firebase.firestore();

            var shortId = getShortId();

            db.collection("MasterNotes").where("shortId", "==", parseInt(shortId)).get()
                .then(function(result) {
                    if (result.docs.length === 1) {
                        db.collection("MasterNotes").doc(result.docs[0].id).update(document)
                            .then(function(result) {
                                $('.message').removeClass('d-none');
                                $('.message').html('<p class="alert alert-success">Note saved</p>');
                            })
                    } else {
                        $('.table-wrapper').addClass('d-none');
                        $('.message').removeClass('d-none');
                        $('.message').html('<p class="alert alert-danger">Could not find the note to update</p>');
                    }
                })
                .catch(function(error){
                    $('.table-wrapper').addClass('d-none');
                    $('.message').removeClass('d-none');
                    $('.message').html('<p class="alert alert-danger">' + error + '</p>');
                });
        }
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    jQuery(document).ready(function ($) {
        var firebaseConfig = {
            apiKey: "AIzaSyBOthBwcREmRXm2OwHDoIQqbzdERufUowE",
            authDomain: "user-notes-d5283.firebaseapp.com",
            databaseURL: "https://user-notes-d5283.firebaseio.com",
            projectId: "user-notes-d5283",
            storageBucket: "user-notes-d5283.appspot.com",
            messagingSenderId: "688290206555",
            appId: "1:688290206555:web:5ecc4a6ba1a7c77d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        updateStats();

        reloadNotes();

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                $('.nav').hide();
                $('.nav-login').show();
            } else {
                $('.nav').show();
                $('.nav-login').hide();
            }

            reloadNotes();
        });

        $(document).on('click', '.master-note-title', function(event) {
            if (firebase.auth().currentUser) {
                var value = $(this).text();
                var $input = $('<input type="text" value="' + value + '" class="master-note-title-input">');
                $input.on('blur', function() {
                    $(this).parent('div').html('<h2 class="master-note-title">' + $(this).val() + '</h2>');
                });
                $input.focus();

                $(this).parent().append($input);
                $(this).remove();
            }
        });

        $(document).on('click', '.add', function() {
            var empty = false;
            var input = $(this).parents("tr").find('input[type="text"]');
            input.each(function(){
                if(!$(this).val()){
                    $(this).addClass("error");
                    empty = true;
                } else{
                    $(this).removeClass("error");
                }
            });
            $(this).parents("tr").find(".error").first().focus();
            if (!empty) {
                $(this).parents("tr").find("td:not(:last-child)").each(function () {
                    $(this).attr('data-name', $(this).find('input').attr('name'))
                    $(this).html($(this).find('input').val());
                });

                $(this).closest('tr').find(".edit, .delete").show();
                $(this).closest('tr').find(".add").hide();
            }
        });

        $(document).on('click', '.edit', function() {
            var inputs = $(this).closest('tr').find("td:not(:last-child)").each(function() {
                $(this).html('<input type="text" class="form-control" name="' + $(this).attr('data-name') + '" value="' + $(this).text() + '">');
            });

            $(this).closest('tr').find(".add, .delete").show();
            $(this).closest('tr').find(".edit").hide();

            $(".add-new").attr("disabled", "disabled");
        });

        $(document).on("click", ".delete", function () {
            $(this).parents("tr").remove();
            $(".add-new").removeAttr("disabled");
        });

        $('#update').on('click', function() {
            if (!hasEmptyRows(true)) {
                updateNote();
            }
        });
    });

    function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();

        firebase.auth().signInWithPopup(provider).then(function (result) {
            createUserIfNotExist();
        }).catch(function (error) {
            $('.table-wrapper').addClass('d-none');
            $('.message').removeClass('d-none');
            $('.message').html('<p class="alert alert-danger">' + error.message + '</p>');
        });
    }

    function facebookLogin() {
        var provider = new firebase.auth.FacebookAuthProvider();

        firebase.auth().signInWithPopup(provider).then(function (result) {
            createUserIfNotExist();
        }).catch(function (error) {
            $('.table-wrapper').addClass('d-none');
            $('.message').removeClass('d-none');
            $('.message').html('<p class="alert alert-danger">' + error.message + '</p>');
        });
    }

    function logout() {
        firebase.auth().signOut().then(function () {
            $('.nav').show();
            $('.nav-login').hide();
        }, function (error) {
            $('.table-wrapper').addClass('d-none');
            $('.message').removeClass('d-none');
            $('.message').html('<p class="alert alert-danger">Could not signed out</p>');
        });
    }

    function createUserIfNotExist() {
        var db = firebase.firestore();

        const email = firebase.auth().currentUser.email
        const userProfileCollection = db.collection("UserProfile");
        userProfileCollection.where("email", "==", email).get()
            .then(function (result) {
                if (result.docs.length === 0) {
                    userProfileCollection.add({
                        email: email,
                        notes: []
                    });
                }
            })
            .catch(function (error) {
                $('.table-wrapper').addClass('d-none');
                $('.message').removeClass('d-none');
                $('.message').html('<p class="alert alert-danger">Could not get the user</p>');
                console.error(error);
            });
    }
</script>
</body>
</html>
